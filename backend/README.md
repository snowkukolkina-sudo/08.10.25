# üçï DANDY POS Backend

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å –¥–ª—è –∫–∞—Å—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã DANDY —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 18+
- Docker –∏ Docker Compose
- PostgreSQL 15+
- Redis 7+
- RabbitMQ 3.8+

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
```bash
cd backend
npm install
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```bash
cp env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

3. **–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
```bash
npm run docker:up
```

4. **–ò–ª–∏ –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é**
```bash
# –ó–∞–ø—É—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d postgres redis rabbitmq

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
npm run migrate

# –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
npm run seed

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
npm run dev
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã

- **API Gateway** - –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **Catalog Service** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–º —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
- **Orders Service** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏
- **Payments Service** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
- **Users Service** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **Fiscal Service** - —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–∞–±–æ—Ç–∞ —Å –û–§–î

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Backend**: Node.js + Express
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL —Å Knex.js
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis
- **–û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π**: RabbitMQ
- **API**: REST + GraphQL
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: JWT
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Winston
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è**: Docker

## üìä API Endpoints

### REST API

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/v1/users/login` - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- `POST /api/v1/users/register` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)

#### –ö–∞—Ç–∞–ª–æ–≥
- `GET /api/v1/catalog/categories` - –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `GET /api/v1/catalog/products` - –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
- `POST /api/v1/catalog/products` - –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
- `PUT /api/v1/catalog/products/:id` - –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä

#### –ó–∞–∫–∞–∑—ã
- `GET /api/v1/orders` - –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã
- `POST /api/v1/orders` - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
- `PATCH /api/v1/orders/:id/status` - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
- `PATCH /api/v1/orders/:id/cancel` - –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑

#### –ü–ª–∞—Ç–µ–∂–∏
- `GET /api/v1/payments` - –ü–æ–ª—É—á–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏
- `POST /api/v1/payments` - –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- `PATCH /api/v1/payments/:id/process` - –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- `PATCH /api/v1/payments/:id/refund` - –í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞

#### –§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è
- `GET /api/v1/fiscal` - –ü–æ–ª—É—á–∏—Ç—å —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–µ —á–µ–∫–∏
- `POST /api/v1/fiscal/create` - –°–æ–∑–¥–∞—Ç—å —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–π —á–µ–∫
- `POST /api/v1/fiscal/:id/send` - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫ –≤ –û–§–î

### GraphQL API

GraphQL Playground –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3000/graphql`

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```graphql
# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
query GetProducts($filters: ProductFilters) {
  products(filters: $filters) {
    data {
      id
      name
      price
      category {
        name
      }
    }
    pagination {
      page
      total
    }
  }
}

# –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
mutation CreateOrder($input: CreateOrderInput!) {
  createOrder(input: $input) {
    id
    orderNumber
    totalAmount
    status
  }
}

# –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
mutation UpdateOrderStatus($id: ID!, $input: UpdateOrderStatusInput!) {
  updateOrderStatus(id: $id, input: $input) {
    id
    status
    updatedAt
  }
}
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=postgresql://user:password@localhost:5432/dandy_pos
DB_HOST=localhost
DB_PORT=5432
DB_NAME=dandy_pos
DB_USER=dandy_user
DB_PASSWORD=dandy_password

# Redis
REDIS_URL=redis://localhost:6379

# RabbitMQ
RABBITMQ_URL=amqp://user:password@localhost:5672

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=24h

# –°–µ—Ä–≤–µ—Ä
NODE_ENV=development
PORT=3000
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –ú–∏–≥—Ä–∞—Ü–∏–∏
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npm run migrate

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
npx knex migrate:rollback

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
npx knex migrate:make migration_name
```

#### –°–∏–¥—ã (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
```bash
# –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
npm run seed

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–∏–¥
npx knex seed:make seed_name
```

## üîÑ –û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### –°–æ–±—ã—Ç–∏—è

#### –ó–∞–∫–∞–∑—ã
- `order.created` - –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω
- `order.updated` - –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω
- `order.cancelled` - –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω

#### –ü–ª–∞—Ç–µ–∂–∏
- `payment.completed` - –ü–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω
- `payment.failed` - –ü–ª–∞—Ç–µ–∂ –Ω–µ —É–¥–∞–ª—Å—è
- `payment.refunded` - –ü–ª–∞—Ç–µ–∂ –≤–æ–∑–≤—Ä–∞—â–µ–Ω

#### –§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è
- `receipt.sent` - –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –û–§–î
- `receipt.confirmed` - –ß–µ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –û–§–î
- `receipt.failed` - –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–µ–π.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
npm test

# –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
npm run test:coverage

# –¢–µ—Å—Ç—ã –≤ watch —Ä–µ–∂–∏–º–µ
npm run test:watch
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `logs/`:
- `combined.log` - –≤—Å–µ –ª–æ–≥–∏
- `error.log` - —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
- `exceptions.log` - –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `LOG_LEVEL`.

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Production

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ production –æ–∫—Ä—É–∂–µ–Ω–∏—è**
```bash
NODE_ENV=production
DATABASE_URL=postgresql://prod_user:prod_pass@prod_host:5432/dandy_pos_prod
```

2. **–ó–∞–ø—É—Å–∫ –≤ production**
```bash
npm start
```

3. **Docker deployment**
```bash
docker build -t dandy-pos-backend .
docker run -d -p 3000:3000 --env-file .env dandy-pos-backend
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- Health check: `GET /health`
- Metrics: `GET /metrics` (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Prometheus)
- Logs: Winston —Å —Ä–æ—Ç–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (bcrypt)
- Rate limiting
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- Helmet –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [API Documentation](docs/api.md)
- [Database Schema](docs/database.md)
- [GraphQL Schema](docs/graphql.md)
- [Deployment Guide](docs/deployment.md)

## ü§ù –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î, Redis, RabbitMQ
‚îÇ   ‚îú‚îÄ‚îÄ graphql/         # GraphQL —Å—Ö–µ–º–∞ –∏ —Ä–µ–∑–æ–ª–≤–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ middleware/      # Express middleware
‚îÇ   ‚îú‚îÄ‚îÄ services/        # REST API —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ utils/           # –£—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–≥–µ—Ä, –≤–∞–ª–∏–¥–∞—Ü–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ workers/         # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π RabbitMQ
‚îÇ   ‚îî‚îÄ‚îÄ index.js         # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/       # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ seeds/           # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ docker-compose.yml   # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile          # Docker –æ–±—Ä–∞–∑
‚îî‚îÄ‚îÄ package.json        # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã
```

### –°–æ–≥–ª–∞—à–µ–Ω–∏—è

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ESLint –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- –ü–∏—à–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ API –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –°–ª–µ–¥—É–π—Ç–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º REST –∏ GraphQL

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ DANDY.
